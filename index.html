<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="自然体験・イベントを探して予約できるプラットフォーム。トレッキング、カヤック、星空観察など、あなたにぴったりのアクティビティを見つけよう。">
  <title>自然体験プラットフォーム | そとなび</title>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/ddrxsy9jw/image/upload/f_auto,q_auto,w_32/logo_tfqqd0">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/ddrxsy9jw/image/upload/f_auto,q_auto,w_180/logo_tfqqd0">
  <link rel="stylesheet" href="styles.css">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "そとなび",
    "description": "自然体験・イベントを探して予約できるプラットフォーム",
    "url": "https://example.com"
  }
  </script>
  <script>
    // GitHub raw URL（全ページ共通設定）
    window.GITHUB_RAW_BASE = "https://raw.githubusercontent.com/setagayatankyubase-create/trip-platform/main";
  </script>
  <script>
    // ロゴ画像をCloudinaryから取得（data.js読み込み後に実行）
    (function() {
      function setLogoUrl() {
        const logoImage = document.querySelector('.logo-image');
        if (logoImage && typeof window.getLogoUrl === 'function') {
          logoImage.src = window.getLogoUrl();
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setLogoUrl);
      } else {
        setLogoUrl();
      }
    })();
  </script>
<body>
  <header class="main-header" id="main-header">
    <div class="nav">
      <div class="nav-left">
        <a href="index.html" class="logo">
          <img src="" alt="そとなび" class="logo-image">
        </a>
        <div class="header-search" id="header-search" style="display: none;">
          <form class="header-search-form" onsubmit="handleSearch(event)">
            <button type="button" class="header-category-menu-button" id="header-category-menu-button" aria-label="カテゴリメニュー">
              <span class="hamburger-icon">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </button>
            <input type="text" placeholder="行きたい自然体験・場所を探す" name="q" class="header-search-input">
            <button type="submit" class="header-search-button">検索</button>
          </form>
        </div>
      </div>
      <div class="nav-links">
        <a href="list.html">イベント一覧</a>
        <a href="organizer-list.html">提供元</a>
        <a href="column.html">コラム</a>
      </div>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-section-background" id="hero-bg-1" style="opacity: 1;"></div>
    <div class="hero-section-background" id="hero-bg-2"></div>
    <div class="hero-content">
      <h1 class="hero-title">東京のすぐそばに、まだ知らない<br>自然がある</h1>
      <div class="search-wrapper">
        <form class="hero-search-form" id="main-search-form" onsubmit="handleSearch(event)">
          <button type="button" class="category-menu-button" id="category-menu-button" aria-label="カテゴリメニュー">
            <span class="hamburger-icon">
              <span></span>
              <span></span>
              <span></span>
            </span>
          </button>
          <input type="text" id="search-query" placeholder="行きたい自然体験・場所を探す" name="q" class="hero-search-input">
          <button type="submit" class="hero-search-button">検索</button>
        </form>
        <div class="category-menu" id="category-menu">
          <div class="category-menu-content" id="category-menu-list"></div>
        </div>
      </div>
      <p class="hero-subtext">週末を、そとなびで</p>
    </div>
  </section>

  <main>
    <!-- ポップセクション（季節・編集部おすすめ） -->
    <section class="section pop-section">
      <div class="pop-carousel-wrapper">
        <div class="pop-carousel" id="pop-carousel"></div>
      </div>
    </section>

    <!-- 今週のイベント -->
    <section class="section event-block">
      <div class="week-event-header">
        <h2>今週のイベント</h2>
      </div>
      <div class="week-calendar-wrapper">
        <div class="week-calendar" id="week-calendar"></div>
        <button id="next-week-btn" class="week-nav-arrow" onclick="showNextWeek()">→</button>
      </div>
    </section>

    <!-- 直近開催イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>直近開催イベント</h2>
        <a href="list.html?upcoming=1" class="view-all">すべて見る →</a>
      </div>
      <div class="card-carousel-wrapper">
        <div class="card-carousel" id="upcoming-events"></div>
      </div>
    </section>

    <!-- 新着イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>新着イベント</h2>
        <a href="list.html?new=1" class="view-all">すべて見る →</a>
      </div>
      <div class="card-carousel-wrapper">
        <div class="card-carousel" id="new-events"></div>
      </div>
    </section>

    <!-- 人気カテゴリ -->
    <section id="categories" class="section">
      <h2>人気カテゴリ</h2>
      <div class="categories" id="category-list"></div>
    </section>

    <!-- 人気イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>人気イベント</h2>
        <a href="list.html?recommended=1" class="view-all">すべて見る →</a>
      </div>
      <div class="card-carousel-wrapper">
        <div class="card-carousel" id="recommended-events"></div>
      </div>
    </section>
  </main>

  <footer class="main-footer">
    <div class="footer-content">
      <div class="footer-column">
        <h3>サポート</h3>
        <a href="contact.html">お問い合わせ</a>
        <a href="terms.html">利用規約</a>
        <a href="privacy.html">プライバシーポリシー</a>
      </div>
      <div class="footer-column">
        <h3>運営情報</h3>
        <a href="about.html">運営について</a>
      </div>
      <div class="footer-column">
        <h3>掲載について</h3>
        <a href="publish.html">掲載について</a>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-copyright">
        © <span id="current-year"></span> そとなび. 製作
      </div>
    </div>
  </footer>

  <script src="data.js?v=4_2025-12-25"></script>
  <script src="app.js"></script>
  <script>
    // ポップセクションのレンダリング
    function renderPopSection() {
      const container = document.getElementById('pop-carousel');
      if (!container) return;

      // ポップデータ（一時的にハードコード、後でJSONから読み込む）
      const popData = [
        {
          type: 'banner',
          title: '冬のおでかけ',
          subtitle: '冬のテーマパーク・イベント予約開始!',
          badge: 'おすすめ',
          cta: '今すぐチェック',
          image: 'pop1_j2wr9k', // 左側の画像
          bgColor: '#6BB6FF', // 右側の背景色
          link: '/?season=winter'
        },
        {
          type: 'card',
          title: '冬の自然体験',
          subtitle: '雪・野鳥・里山',
          badge: '季節',
          image: 'pop2_go0z71',
          link: '/?season=winter'
        },
        {
          type: 'card',
          title: '春の自然観察',
          subtitle: '植物・生き物・里山',
          badge: '季節',
          image: 'pop3_y2bf8t',
          link: '/?season=spring'
        }
      ];

      if (!popData || popData.length === 0) {
        container.parentElement.parentElement.style.display = 'none';
        return;
      }

      container.innerHTML = popData.map(pop => {
        if (pop.type === 'banner') {
          // トップバナー（2列構成）
          let imageUrl = '';
          if (pop.image) {
            if (typeof window.cloudinaryUrl === 'function') {
              imageUrl = window.cloudinaryUrl(pop.image, { w: 640, h: 480 });
            } else if (pop.image.startsWith('http')) {
              imageUrl = pop.image;
            } else {
              imageUrl = `https://res.cloudinary.com/ddrxsy9jw/image/upload/f_auto,q_auto,w_640,h_480/${pop.image}`;
            }
          }

          const imageStyle = imageUrl 
            ? `background-image: url('${imageUrl.replace(/'/g, "\\'")}');`
            : '';
          
          const bgColor = pop.bgColor || '#6BB6FF';

          return `
            <a href="${pop.link || '#'}" class="pop-banner">
              <div class="pop-banner-image" style="${imageStyle}">
                <div class="pop-banner-image-overlay">
                  ${pop.badge ? `<span class="pop-banner-badge">${pop.badge}</span>` : ''}
                  <div class="pop-banner-title">
                    ${pop.title || ''}
                  </div>
                  <div style="font-size: 0.9rem; margin-top: 8px;">チケット・パス・体験</div>
                </div>
              </div>
              <div class="pop-banner-content" style="background: ${bgColor};">
                <div class="pop-banner-subtitle">${pop.subtitle || ''}</div>
                ${pop.cta ? `<span class="pop-banner-button">${pop.cta}</span>` : ''}
              </div>
            </a>
          `;
        } else {
          // キャンペーンカード
          let imageUrl = '';
          if (pop.image) {
            if (typeof window.cloudinaryUrl === 'function') {
              imageUrl = window.cloudinaryUrl(pop.image, { w: 640, h: 480 });
            } else if (pop.image.startsWith('http')) {
              imageUrl = pop.image;
            } else {
              imageUrl = `https://res.cloudinary.com/ddrxsy9jw/image/upload/f_auto,q_auto,w_640,h_480/${pop.image}`;
            }
          }

          const imageStyle = imageUrl 
            ? `background-image: url('${imageUrl.replace(/'/g, "\\'")}');`
            : '';

          return `
            <a href="${pop.link || '#'}" class="pop-card">
              <div class="pop-card-image" style="${imageStyle}">
                <div class="pop-card-overlay">
                  ${pop.badge ? `<span class="pop-card-badge">${pop.badge}</span>` : ''}
                  <div class="pop-card-title">${pop.title || ''}</div>
                  ${pop.subtitle ? `<div class="pop-card-subtitle">${pop.subtitle}</div>` : ''}
                  <span class="pop-card-cta">詳しく見る →</span>
                </div>
              </div>
            </a>
          `;
        }
      }).join('');
    }

    // カテゴリIDからlucide-staticアイコン名へのマッピング
    const categoryIconMap = {
      'river-water': 'waves',
      'sea-beach': 'shell',
      'mountain-satoyama': 'mountain',
      'forest': 'trees',
      'wildlife': 'paw-print',
      'farm-harvest': 'wheat',
      'animals': 'dog',
      'fire-outdoor': 'flame',
      'camp': 'tent',
      'natural-materials': 'leaf',
      'cycling': 'bike',
      'seasonal': 'sun-snow'
    };

    // カテゴリアイコンのURLを取得
    function getCategoryIconUrl(categoryId) {
      const iconName = categoryIconMap[categoryId];
      if (!iconName) return '';
      return `https://cdn.jsdelivr.net/npm/lucide-static@latest/icons/${iconName}.svg`;
    }

    // カテゴリ一覧の表示（人気カテゴリ：イベント数の多い順に最大6件）
    function renderCategories() {
      const container = document.getElementById('category-list');
      if (!container) return;

      // eventMeta.categories を優先、なければ eventData.categories を使用
      const categories = (window.eventMeta && window.eventMeta.categories) 
        ? window.eventMeta.categories 
        : (window.eventData && window.eventData.categories) 
          ? window.eventData.categories 
          : null;
      
      console.log('[index.html] renderCategories - categories:', categories);
      
      if (!categories || !Array.isArray(categories) || categories.length === 0) {
        console.warn('[index.html] renderCategories - No categories found');
        return;
      }

      // イベントごとのカテゴリ出現回数を集計
      const events = (window.eventData && Array.isArray(window.eventData.events))
        ? window.eventData.events
        : [];

      const counts = {};
      if (events.length > 0) {
        events.forEach(ev => {
          const ids = new Set();
          if (ev.categoryId) ids.add(String(ev.categoryId));
          if (ev.category_id) ids.add(String(ev.category_id));
          if (ev.category) ids.add(String(ev.category));
          if (Array.isArray(ev.categories)) {
            ev.categories.forEach(c => {
              if (!c) return;
              if (typeof c === 'string') {
                ids.add(c);
              } else if (c.id) {
                ids.add(String(c.id));
              }
            });
          }
          ids.forEach(id => {
            counts[id] = (counts[id] || 0) + 1;
          });
        });
      }

      console.log('[index.html] renderCategories - counts:', counts);

      // 人気順にソートし、最大6件に絞る
      let sorted = categories.slice();
      if (Object.keys(counts).length > 0) {
        sorted.sort((a, b) => {
          const ca = counts[a.id] || 0;
          const cb = counts[b.id] || 0;
          if (cb !== ca) return cb - ca; // 多い順
          // 同数なら元の順序を維持（idで安定ソート）
          return String(a.id).localeCompare(String(b.id));
        });

        // 1件以上イベントがあるカテゴリだけに絞る
        sorted = sorted.filter(cat => (counts[cat.id] || 0) > 0);
      }

      // 最大6件まで
      const topCategories = sorted.slice(0, 6);

      container.innerHTML = topCategories.map(cat => {
        const iconUrl = getCategoryIconUrl(cat.id);
        return `
        <a href="list.html?category=${cat.id}" class="cat">
          ${iconUrl ? `<img src="${iconUrl}" alt="${cat.name || ''}" class="category-icon" />` : '<span></span>'}
          <span>${cat.name || ''}</span>
        </a>
      `;
      }).join('');
    }

    // カテゴリメニューの位置を計算（fixed position用）
    function positionCategoryMenu() {
      const btn = document.getElementById('category-menu-button');
      const menu = document.querySelector('.category-menu');
      if (!btn || !menu) return;

      const rect = btn.getBoundingClientRect();
      const gap = 8;

      menu.style.top = `${rect.bottom + gap}px`;
      menu.style.left = `${rect.left}px`;

      // 右にはみ出す場合の保険
      const menuRect = menu.getBoundingClientRect();
      const overflowRight = menuRect.right - window.innerWidth;
      if (overflowRight > 0) {
        menu.style.left = `${Math.max(8, rect.left - overflowRight - 8)}px`;
      }

      // 下にはみ出す場合は max-height を調整
      const available = window.innerHeight - (rect.bottom + gap) - 8;
      menu.style.maxHeight = `${Math.max(120, available)}px`;
    }

    // カテゴリメニューを初期化（ホバーで表示されるので、事前にレンダリングしておく）
    function initCategoryMenu() {
      const menuList = document.getElementById('category-menu-list');
      if (!menuList) return;

      // eventMeta.categories を優先、なければ eventData.categories を使用
      const categories = (window.eventMeta && window.eventMeta.categories) 
        ? window.eventMeta.categories 
        : (window.eventData && window.eventData.categories) 
          ? window.eventData.categories 
          : null;
      
      console.log('[index.html] initCategoryMenu - categories:', categories);
      
      if (!categories || !Array.isArray(categories) || categories.length === 0) {
        console.warn('[index.html] initCategoryMenu - No categories found');
        return;
      }
      
      menuList.innerHTML = categories.map(cat => {
        const iconUrl = getCategoryIconUrl(cat.id);
        return `
        <a href="list.html?category=${cat.id}" class="category-menu-item">
          ${iconUrl ? `<img src="${iconUrl}" alt="${cat.name || ''}" class="icon" />` : '<span class="icon"></span>'}
          <span class="name">${cat.name || ''}</span>
        </a>
      `;
      }).join('');

      const menu = document.querySelector('.category-menu');
      const categoryButton = document.getElementById('category-menu-button');
      let hideTimer = null;

      // メニューを表示する関数
      function showMenu() {
        if (hideTimer) {
          clearTimeout(hideTimer);
          hideTimer = null;
        }
        positionCategoryMenu();
        menu.style.opacity = '1';
        menu.style.visibility = 'visible';
        menu.style.pointerEvents = 'auto';
        menu.style.transform = 'translateY(0)';
      }

      // メニューを非表示にする関数（3秒後）
      function hideMenu() {
        if (hideTimer) {
          clearTimeout(hideTimer);
        }
        hideTimer = setTimeout(() => {
          menu.style.opacity = '0';
          menu.style.visibility = 'hidden';
          menu.style.pointerEvents = 'none';
          menu.style.transform = 'translateY(-10px)';
          hideTimer = null;
        }, 600); // 0.6秒後
      }

      // ハンバーガーボタンにカーソルが入った時のみ表示
      if (categoryButton) {
        categoryButton.addEventListener('mouseenter', showMenu);
        categoryButton.addEventListener('mouseleave', hideMenu);
      }

      // メニュー自体にカーソルが入った時（メニュー内を移動する際に非表示にならないように）
      if (menu) {
        menu.addEventListener('mouseenter', showMenu);
        menu.addEventListener('mouseleave', hideMenu);
      }

      // リサイズ/スクロール時にも位置を更新
      window.addEventListener('resize', () => {
        if (menu && menu.style.visibility !== 'hidden') {
          positionCategoryMenu();
        }
      });

      window.addEventListener('scroll', () => {
        if (menu && menu.style.visibility !== 'hidden') {
          positionCategoryMenu();
        }
      }, { passive: true });
    }

    // スクロール時にヘッダーに検索欄を表示
    function initHeaderSearch() {
      const header = document.getElementById('main-header');
      const headerSearch = document.getElementById('header-search');
      const heroSearchForm = document.getElementById('main-search-form');
      const headerSearchForm = headerSearch?.querySelector('.header-search-form');
      const heroSearchInput = document.getElementById('search-query');
      const headerSearchInput = headerSearch?.querySelector('.header-search-input');

      if (!header || !headerSearch || !heroSearchForm || !headerSearchForm) return;

      // スクロールイベント
      window.addEventListener('scroll', () => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        // スクロールしたら検索欄を表示
        if (scrollTop > 100) {
          headerSearch.style.display = 'flex';
          header.classList.add('scrolled');
        } else {
          headerSearch.style.display = 'none';
          header.classList.remove('scrolled');
        }
      }, { passive: true });

      // 検索入力の同期（ヒーローとヘッダー）
      if (heroSearchInput && headerSearchInput) {
        heroSearchInput.addEventListener('input', (e) => {
          headerSearchInput.value = e.target.value;
        });
        headerSearchInput.addEventListener('input', (e) => {
          heroSearchInput.value = e.target.value;
        });
      }

      // ヘッダーのカテゴリメニューボタンにもイベントを設定
      const headerCategoryButton = document.getElementById('header-category-menu-button');
      if (headerCategoryButton) {
        // カテゴリメニューの初期化を待つ
        setTimeout(() => {
          const menu = document.querySelector('.category-menu');
          if (menu) {
            let hideTimer = null;

            function showMenu() {
              if (hideTimer) {
                clearTimeout(hideTimer);
                hideTimer = null;
              }
              const btnRect = headerCategoryButton.getBoundingClientRect();
              menu.style.top = `${btnRect.bottom + 8}px`;
              menu.style.left = `${btnRect.left}px`;
              menu.style.opacity = '1';
              menu.style.visibility = 'visible';
              menu.style.pointerEvents = 'auto';
              menu.style.transform = 'translateY(0)';
            }

            function hideMenu() {
              if (hideTimer) {
                clearTimeout(hideTimer);
              }
              hideTimer = setTimeout(() => {
                menu.style.opacity = '0';
                menu.style.visibility = 'hidden';
                menu.style.pointerEvents = 'none';
                menu.style.transform = 'translateY(-10px)';
                hideTimer = null;
              }, 600);
            }

            headerCategoryButton.addEventListener('mouseenter', showMenu);
            headerCategoryButton.addEventListener('mouseleave', hideMenu);
            menu.addEventListener('mouseenter', showMenu);
            menu.addEventListener('mouseleave', hideMenu);
          }
        }, 100);
      }
    }

    // ページ読み込み後に初期化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initHeaderSearch();
      });
    } else {
      initHeaderSearch();
    }


    // 検索処理
    function handleSearch(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const params = {
        q: formData.get('q') || '',
        category: formData.get('category') || '',
        date: formData.get('date') || '',
        area: formData.get('area') || ''
      };
      URLManager.setParams(params);
      window.location.href = `list.html?${new URLSearchParams(params).toString()}`;
    }

    // 曜日検索
    function searchByWeekday(weekday) {
      window.location.href = `list.html?weekday=${weekday}`;
    }

    // 週のオフセット（0=今週、1=次週、-1=先週など）
    let weekOffset = 0;

    // 当日始まりの1週間分を表示（次週ボタンでスライド入れ替え）
    function renderWeekCalendar(offset = 0) {
      const container = document.getElementById('week-calendar');
      if (!container) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // 当日始まりの1週間分を取得（offset=0なら今日から7日間、offset=1なら8日目から14日間）
      const startDate = new Date(today);
      startDate.setDate(today.getDate() + (offset * 7));

      const weekDays = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        weekDays.push(date);
      }

      // 各日のイベント数をカウント
      const eventCounts = {};
      weekDays.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const count = (window.eventData?.events || []).filter(event =>
          event.dates && Array.isArray(event.dates) && event.dates.some(d => d.date === dateStr)
        ).length;
        eventCounts[dateStr] = count;
      });

      // 今日の日付文字列
      const todayStr = today.toISOString().split('T')[0];

      // 曜日名
      const weekDayNames = ['日', '月', '火', '水', '木', '金', '土'];

      // リスト生成
      let html = '<div class="week-calendar-list">';

      weekDays.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const dayIndex = date.getDay(); // 0=日曜日, 1=月曜日, ..., 6=土曜日
        const dayName = weekDayNames[dayIndex];
        const count = eventCounts[dateStr] || 0;
        const isToday = dateStr === todayStr;
        const hasEvents = count > 0;

        let itemClass = 'week-day-item';
        if (isToday) itemClass += ' today';
        if (hasEvents) itemClass += ' has-events';

        html += `<div class="${itemClass}" onclick="goToDateEvents('${dateStr}')">`;
        html += `<span class="week-day-date">${month}/${day}</span>`;
        html += `<span class="week-day-name">${dayName}</span>`;
        if (hasEvents) {
          html += `<span class="week-day-count">${count}件</span>`;
        }
        html += `</div>`;
      });

      html += '</div>';
      
      // スライドアニメーション用のクラスを追加
      container.classList.add('week-calendar-sliding');
      setTimeout(() => {
        container.classList.remove('week-calendar-sliding');
      }, 300);
      
      container.innerHTML = html;

      // 次週ボタンの表示を更新
      const nextWeekBtn = document.getElementById('next-week-btn');
      if (nextWeekBtn) {
        if (offset === 0) {
          nextWeekBtn.textContent = '→';
          nextWeekBtn.onclick = () => showNextWeek();
        } else {
          nextWeekBtn.textContent = '←';
          nextWeekBtn.onclick = () => showThisWeek();
        }
      }
    }

    // 次週を表示
    function showNextWeek() {
      weekOffset = 1;
      renderWeekCalendar(weekOffset);
    }

    // 今週を表示
    function showThisWeek() {
      weekOffset = 0;
      renderWeekCalendar(weekOffset);
    }

    // 日付クリックでイベント一覧に遷移
    function goToDateEvents(dateStr) {
      window.location.href = `list.html?date=${dateStr}`;
    }

    // イベントブロックの表示（events_index ベース）
    async function renderEventBlocks() {
      const MAX_HOME_EVENTS = 8;
      
      // eventIndex を優先、なければ eventData.events から構築
      let source = Array.isArray(window.eventIndex) && window.eventIndex.length > 0
        ? window.eventIndex
        : (Array.isArray(window.eventData?.events) ? window.eventData.events : []);
      
      // next_date が無い場合、最初の数件の詳細JSONから日付を補完
      if (source.length > 0 && !source[0].next_date && !source[0].date_min && (!source[0].dates || source[0].dates.length === 0)) {
        console.log('[renderEventBlocks] next_date not found, enriching from detail JSONs...');
        try {
          const sampleIds = source.slice(0, 20).map(e => e.id).filter(Boolean);
          const detailPromises = sampleIds.map(id => 
            loadEventDetail(id).catch(() => null)
          );
          const details = await Promise.all(detailPromises);
          const detailMap = {};
          details.forEach(d => {
            if (d && d.id) detailMap[d.id] = d;
          });
          
          // source に dates を補完
          source = source.map(item => {
            const detail = detailMap[item.id];
            if (detail && detail.dates && Array.isArray(detail.dates) && detail.dates.length > 0) {
              return { ...item, dates: detail.dates, next_date: detail.dates[0].date };
            }
            return item;
          });
        } catch (e) {
          console.warn('[renderEventBlocks] Failed to enrich dates:', e);
        }
      }

      console.log('[renderEventBlocks] source length:', source.length);
      if (source.length > 0) {
        console.log('[renderEventBlocks] sample event:', source[0]);
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // おすすめ：isRecommended でフィルタ
      const recommended = source
        .filter(e => e.isRecommended)
        .slice(0, MAX_HOME_EVENTS);

      // 新着：isNew でフィルタ（publishedAt があればそれでソート、なければそのまま）
      const newEvents = source
        .filter(e => e.isNew)
        .sort((a, b) => {
          const aDate = a.publishedAt ? new Date(a.publishedAt) : new Date(0);
          const bDate = b.publishedAt ? new Date(b.publishedAt) : new Date(0);
          return bDate - aDate; // 新しい順
        })
        .slice(0, MAX_HOME_EVENTS);

      // 直近開催：source（eventIndex、日付補完済み）から、今日以降のイベントを日付の近い順にソート
      console.log('[renderEventBlocks] source for upcoming:', source.length);
      if (source.length > 0) {
        console.log('[renderEventBlocks] first event:', source[0]);
        console.log('[renderEventBlocks] first event dates:', source[0].dates);
        console.log('[renderEventBlocks] first event next_date:', source[0].next_date);
      }
      console.log('[renderEventBlocks] today:', today.toISOString().split('T')[0]);
      
      // dates または next_date から日付を取得するヘルパー
      const getEventDate = (event) => {
        // dates 配列から取得（優先）
        if (event.dates && event.dates.length > 0 && event.dates[0] && event.dates[0].date) {
          const d = new Date(event.dates[0].date);
          if (!isNaN(d.getTime())) {
            return d;
          }
        }
        // next_date から取得（フォールバック）
        if (event.next_date) {
          const d = new Date(event.next_date);
          if (!isNaN(d.getTime())) {
            return d;
          }
        }
        // date_min から取得（フォールバック）
        if (event.date_min) {
          const d = new Date(event.date_min);
          if (!isNaN(d.getTime())) {
            return d;
          }
        }
        return null;
      };
      
      const upcomingCandidatesWithDates = source.map(event => {
        const eventDate = getEventDate(event);
        return { event, eventDate };
      });
      
      console.log('[renderEventBlocks] events with valid dates:', 
        upcomingCandidatesWithDates.filter(({ eventDate }) => eventDate !== null).length
      );
      
      const upcomingCandidates = upcomingCandidatesWithDates
        .filter(({ event, eventDate }) => {
          if (!eventDate || isNaN(eventDate.getTime())) {
            console.log('[renderEventBlocks] rejected (no date):', event.id);
            return false;
          }
          const eventDateOnly = new Date(eventDate);
          eventDateOnly.setHours(0, 0, 0, 0);
          const isUpcoming = eventDateOnly >= today;
          if (!isUpcoming) {
            console.log('[renderEventBlocks] rejected (past date):', event.id, eventDateOnly.toISOString().split('T')[0], 'today:', today.toISOString().split('T')[0]);
          }
          return isUpcoming;
        });
      
      console.log('[renderEventBlocks] upcomingCandidates:', upcomingCandidates.length);
      upcomingCandidates.forEach(({ event, eventDate }) => {
        console.log('[renderEventBlocks] upcoming:', event.id, event.title, eventDate.toISOString().split('T')[0]);
      });
      
      const upcoming = upcomingCandidates
        .sort((a, b) => a.eventDate - b.eventDate) // 日付の近い順（早い順）
        .slice(0, MAX_HOME_EVENTS)
        .map(({ event }) => event); // event オブジェクトのみを返す
      
      console.log('[renderEventBlocks] final upcoming count:', upcoming.length);

      // CardRendererが定義されているか確認
      if (typeof CardRenderer === 'undefined' || !CardRenderer.renderCarousel) {
        console.error('CardRenderer is not defined. Make sure app.js is loaded.');
        return;
      }

      CardRenderer.renderCarousel(recommended, 'recommended-events');
      CardRenderer.renderCarousel(newEvents, 'new-events');
      CardRenderer.renderCarousel(upcoming, 'upcoming-events');
    }

    // カルーセルスクロール
    function scrollCarousel(carouselId, direction) {
      const carousel = document.getElementById(carouselId);
      if (!carousel) return;
      
      const scrollAmount = 400;
      const currentScroll = carousel.scrollLeft;
      const newScroll = direction === 'right' 
        ? currentScroll + scrollAmount 
        : currentScroll - scrollAmount;
      
      carousel.scrollTo({
        left: newScroll,
        behavior: 'smooth'
      });
    }

    // ヒーロー背景画像の自動切り替え（滑らかなフェード）
    function setupHeroBackground() {
      // Cloudinaryからヒーロー画像URLを取得
      const heroImages = [];
      if (typeof window.getHeroImageUrl === 'function') {
        heroImages.push(window.getHeroImageUrl('winter_ctfkee'));
        heroImages.push(window.getHeroImageUrl('fuji_ebl1nh'));
      } else {
        // フォールバック（Cloudinary関数が利用できない場合） - 空の配列にする
        console.warn('[setupHeroBackground] getHeroImageUrl is not available');
      }

      // 画像を事前に読み込む
      heroImages.forEach(src => {
        const img = new Image();
        img.src = src;
      });

      const bg1 = document.getElementById('hero-bg-1');
      const bg2 = document.getElementById('hero-bg-2');
      if (!bg1 || !bg2) return;

      // 背景画像を設定
      if (heroImages[0]) {
        bg1.style.backgroundImage = `url('${heroImages[0]}')`;
      }
      if (heroImages[1]) {
        bg2.style.backgroundImage = `url('${heroImages[1]}')`;
      }

      let currentBg = bg1;
      let nextBg = bg2;

      function changeBackground() {
        // 次の画像を表示
        nextBg.classList.add('active');
        currentBg.classList.remove('active');
        
        // 次の切り替えのために入れ替え
        const temp = currentBg;
        currentBg = nextBg;
        nextBg = temp;
      }

      // 5秒ごとに切り替え
      setInterval(changeBackground, 5000);
    }

    // 初期化（イベントデータ読み込み → 描画）
    document.addEventListener('DOMContentLoaded', async () => {
      // ヒーロー背景画像の自動切り替えを開始
      setupHeroBackground();
      try {
        // イベントデータを読み込み（data.js で定義）
        await loadEventData();
        
        // メタデータ（カテゴリ・提供元）を読み込み
        if (typeof loadEventMeta === 'function') {
          try {
            await loadEventMeta();
          } catch (e) {
            console.warn('Failed to load eventMeta:', e);
          }
        }
        
        // eventIndex が読み込まれているか確認（なければ再読み込み）
        if (!Array.isArray(window.eventIndex) || window.eventIndex.length === 0) {
          try {
            await loadEventIndex();
          } catch (e) {
            console.warn('Failed to load eventIndex:', e);
          }
        }

        const yearElement = document.getElementById('current-year');
        if (yearElement) {
          yearElement.textContent = new Date().getFullYear();
        }

        renderPopSection(); // ポップセクションを描画
        renderCategories();
        initCategoryMenu(); // カテゴリメニューを初期化（ホバー表示用）
        renderWeekCalendar();
        await renderEventBlocks();

      } catch (e) {
        console.error(e);
        const el = document.getElementById('error');
        if (el) el.textContent = 'データの読み込みに失敗しました';
      }
    });
  </script>
</body>
</html>
