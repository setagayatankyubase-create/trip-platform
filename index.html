<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="自然体験・イベントを探して予約できるプラットフォーム。トレッキング、カヤック、星空観察など、あなたにぴったりのアクティビティを見つけよう。">
  <title>自然体験プラットフォーム | GreenTrails</title>
  <link rel="stylesheet" href="styles.css">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "GreenTrails",
    "description": "自然体験・イベントを探して予約できるプラットフォーム",
    "url": "https://example.com"
  }
  </script>
</head>
<body>
  <header>
    <div class="nav">
      <div class="logo">GreenTrails</div>
      <div class="nav-links">
        <a href="index.html">ホーム</a>
        <a href="list.html">イベント一覧</a>
        <a href="organizer-list.html">催行会社</a>
      </div>
    </div>
    <div class="search-bar">
      <form class="search-form" id="main-search-form" onsubmit="handleSearch(event)">
        <input type="text" id="search-query" placeholder="体験名・語句で検索（例: 屋久島、トレッキング）" name="q">
        <select id="search-category" name="category">
          <option value="">すべてのカテゴリ</option>
        </select>
        <input type="date" id="search-date" name="date">
        <select id="search-area" name="area">
          <option value="">すべてのエリア</option>
        </select>
        <button type="submit">検索</button>
      </form>
      <div class="search-quick-buttons">
        <button type="button" onclick="searchByWeekday('this-weekend')">今週末</button>
        <button type="button" onclick="searchByWeekday('next-holiday')">次の祝日</button>
      </div>
    </div>
  </header>

  <main>
    <!-- カテゴリ -->
    <section id="categories" class="section">
      <h2>人気カテゴリ</h2>
      <div class="categories" id="category-list"></div>
    </section>

    <!-- 今週のイベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>今週のイベント</h2>
      </div>
      <div class="week-calendar" id="week-calendar"></div>
    </section>

    <!-- おすすめイベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>おすすめイベント</h2>
        <a href="list.html?recommended=1" class="view-all">すべて見る →</a>
      </div>
      <div class="grid" id="recommended-events"></div>
    </section>

    <!-- 新着イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>新着イベント</h2>
        <a href="list.html?new=1" class="view-all">すべて見る →</a>
      </div>
      <div class="grid" id="new-events"></div>
    </section>

    <!-- 直近開催イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>直近開催イベント</h2>
        <a href="list.html?upcoming=1" class="view-all">すべて見る →</a>
      </div>
      <div class="grid" id="upcoming-events"></div>
    </section>
  </main>

  <footer style="margin: 44px auto 20px; padding: 0 18px; text-align: center; color: #6c7a72; font-size: 0.92rem;">
    © 2025 GreenTrails. 自然体験をもっと身近に。
  </footer>

  <script src="data.js"></script>
  <script src="app.js"></script>
  <script>
    // カテゴリ一覧の表示
    function renderCategories() {
      const container = document.getElementById('category-list');
      if (!container) return;

      container.innerHTML = eventData.categories.map(cat => `
        <a href="list.html?category=${cat.id}" class="cat">
          <span>${cat.icon}</span>
          <span>${cat.name}</span>
        </a>
      `).join('');
    }

    // カテゴリ・エリアの選択肢を設定
    function populateSearchOptions() {
      const categorySelect = document.getElementById('search-category');
      const areaSelect = document.getElementById('search-area');

      if (categorySelect) {
        eventData.categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = cat.name;
          categorySelect.appendChild(option);
        });
      }

      if (areaSelect) {
        eventData.areas.forEach(area => {
          const option = document.createElement('option');
          option.value = area;
          option.textContent = area;
          areaSelect.appendChild(option);
        });
      }
    }

    // 検索処理
    function handleSearch(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const params = {
        q: formData.get('q') || '',
        category: formData.get('category') || '',
        date: formData.get('date') || '',
        area: formData.get('area') || ''
      };
      URLManager.setParams(params);
      window.location.href = `list.html?${new URLSearchParams(params).toString()}`;
    }

    // 曜日検索
    function searchByWeekday(weekday) {
      window.location.href = `list.html?weekday=${weekday}`;
    }

    // 今週のカレンダー表示
    function renderWeekCalendar() {
      const container = document.getElementById('week-calendar');
      if (!container) return;

      const today = new Date();
      const dayOfWeek = today.getDay(); // 0=日曜日, 6=土曜日
      const startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - dayOfWeek); // 今週の日曜日

      // 今週の7日間を取得
      const weekDays = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startOfWeek);
        date.setDate(startOfWeek.getDate() + i);
        weekDays.push(date);
      }

      // 各日のイベント数をカウント
      const eventCounts = {};
      weekDays.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const count = eventData.events.filter(event =>
          event.dates.some(d => d.date === dateStr)
        ).length;
        eventCounts[dateStr] = count;
      });

      // 今日の日付文字列
      const todayStr = today.toISOString().split('T')[0];

      // 曜日名
      const weekDayNames = ['日', '月', '火', '水', '木', '金', '土'];

      // テーブル生成
      let html = '<table class="week-calendar-table">';
      html += '<thead><tr>';
      weekDayNames.forEach(name => {
        html += `<th>${name}</th>`;
      });
      html += '</tr></thead>';
      html += '<tbody><tr>';

      weekDays.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const dayNumber = date.getDate();
        const dayName = weekDayNames[date.getDay()];
        const count = eventCounts[dateStr] || 0;
        const isToday = dateStr === todayStr;
        const hasEvents = count > 0;

        let cellClass = 'week-day-cell';
        if (isToday) cellClass += ' today';
        if (hasEvents) cellClass += ' has-events';

        html += `<td>`;
        html += `<div class="${cellClass}" onclick="goToDateEvents('${dateStr}')">`;
        html += `<div class="week-day-number">${dayNumber}</div>`;
        html += `<div class="week-day-name">${dayName}</div>`;
        if (hasEvents) {
          html += `<div class="week-day-count">${count}件</div>`;
        }
        html += `</div>`;
        html += `</td>`;
      });

      html += '</tr></tbody></table>';
      container.innerHTML = html;
    }

    // 日付クリックでイベント一覧に遷移
    function goToDateEvents(dateStr) {
      window.location.href = `list.html?date=${dateStr}`;
    }

    // イベントブロックの表示
    function renderEventBlocks() {
      const recommended = SearchFilter.getRecommendedEvents(eventData.events).slice(0, 3);
      const newEvents = SearchFilter.getNewEvents(eventData.events).slice(0, 3);
      const upcoming = SearchFilter.getUpcomingEvents(eventData.events, 7).slice(0, 3);

      CardRenderer.renderList(recommended, 'recommended-events');
      CardRenderer.renderList(newEvents, 'new-events');
      CardRenderer.renderList(upcoming, 'upcoming-events');
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
      renderCategories();
      populateSearchOptions();
      renderWeekCalendar();
      renderEventBlocks();
    });
  </script>
</body>
</html>
