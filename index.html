<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="自然体験・イベントを探して予約できるプラットフォーム。トレッキング、カヤック、星空観察など、あなたにぴったりのアクティビティを見つけよう。">
  <title>自然体験プラットフォーム | そとなび</title>
  <link rel="stylesheet" href="styles.css">
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "そとなび",
    "description": "自然体験・イベントを探して予約できるプラットフォーム",
    "url": "https://example.com"
  }
  </script>
</head>
<body>
  <header class="main-header" id="main-header">
    <div class="nav">
      <div class="nav-left">
        <a href="index.html" class="logo">
          <img src="assets/sotonavi-logo.png" alt="そとなび" class="logo-image">
        </a>
        <div class="header-search" id="header-search" style="display: none;">
          <form class="header-search-form" onsubmit="handleSearch(event)">
            <input type="text" placeholder="行きたい自然体験・場所を探す" name="q" class="header-search-input">
            <button type="submit" class="header-search-button">検索</button>
          </form>
        </div>
      </div>
      <div class="nav-links">
        <a href="list.html">イベント一覧</a>
        <a href="organizer-list.html">提供元</a>
      </div>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">東京のすぐそばに、まだ知らない自然がある</h1>
      <form class="hero-search-form" id="main-search-form" onsubmit="handleSearch(event)">
        <input type="text" id="search-query" placeholder="行きたい自然体験・場所を探す" name="q" class="hero-search-input">
        <button type="submit" class="hero-search-button">検索</button>
      </form>
      <p class="hero-subtext">週末の外日和を、そとなびで</p>
    </div>
  </section>

  <main>
    <!-- 今週のイベント -->
    <section class="section event-block">
      <div class="week-event-header">
        <h2>今週のイベント</h2>
      </div>
      <div class="week-calendar-wrapper">
        <div class="week-calendar" id="week-calendar"></div>
        <button id="next-week-btn" class="week-nav-arrow" onclick="showNextWeek()">→</button>
      </div>
    </section>

    <!-- 直近開催イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>直近開催イベント</h2>
        <a href="list.html?upcoming=1" class="view-all">すべて見る →</a>
      </div>
      <div class="card-carousel-wrapper">
        <div class="card-carousel" id="upcoming-events"></div>
      </div>
    </section>

    <!-- 新着イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>新着イベント</h2>
        <a href="list.html?new=1" class="view-all">すべて見る →</a>
      </div>
      <div class="card-carousel-wrapper">
        <div class="card-carousel" id="new-events"></div>
      </div>
    </section>

    <!-- 人気カテゴリ -->
    <section id="categories" class="section">
      <h2>人気カテゴリ</h2>
      <div class="categories" id="category-list"></div>
    </section>

    <!-- 人気イベント -->
    <section class="section event-block">
      <div class="event-block-header">
        <h2>人気イベント</h2>
        <a href="list.html?recommended=1" class="view-all">すべて見る →</a>
      </div>
      <div class="card-carousel-wrapper">
        <div class="card-carousel" id="recommended-events"></div>
      </div>
    </section>
  </main>

  <footer class="main-footer">
    <div class="footer-content">
      <div class="footer-column">
        <h3>サポート</h3>
        <a href="contact.html">お問い合わせ</a>
        <a href="terms.html">利用規約</a>
        <a href="privacy.html">プライバシーポリシー</a>
      </div>
      <div class="footer-column">
        <h3>運営情報</h3>
        <a href="about.html">運営について</a>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-copyright">
        © <span id="current-year"></span> そとなび. 製作
      </div>
    </div>
  </footer>

  <script src="data.js"></script>
  <script src="app.js"></script>
  <script>
    // カテゴリ一覧の表示（eventMeta ベース）
    function renderCategories() {
      const container = document.getElementById('category-list');
      if (!container) return;

      const categories = (window.eventMeta && window.eventMeta.categories)
        ? window.eventMeta.categories
        : (window.eventData && window.eventData.categories) ? window.eventData.categories : [];

      container.innerHTML = categories.map(cat => `
        <a href="list.html?category=${cat.id}" class="cat">
          <span>${cat.icon}</span>
          <span>${cat.name}</span>
        </a>
      `).join('');
    }


    // 検索処理
    function handleSearch(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const params = {
        q: formData.get('q') || '',
        category: formData.get('category') || '',
        date: formData.get('date') || '',
        area: formData.get('area') || ''
      };
      URLManager.setParams(params);
      window.location.href = `list.html?${new URLSearchParams(params).toString()}`;
    }

    // 曜日検索
    function searchByWeekday(weekday) {
      window.location.href = `list.html?weekday=${weekday}`;
    }

    // 週のオフセット（0=今週、1=次週、-1=先週など）
    let weekOffset = 0;

    // 当日始まりの1週間分を表示（次週ボタンでスライド入れ替え）
    function renderWeekCalendar(offset = 0) {
      const container = document.getElementById('week-calendar');
      if (!container) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // 当日始まりの1週間分を取得（offset=0なら今日から7日間、offset=1なら8日目から14日間）
      const startDate = new Date(today);
      startDate.setDate(today.getDate() + (offset * 7));

      const weekDays = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        weekDays.push(date);
      }

      // 各日のイベント数をカウント（eventIndex ベース）
      const eventCounts = {};
      const index = Array.isArray(window.eventIndex) ? window.eventIndex : [];
      weekDays.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const count = index.filter(event => {
          // next_date がその日と同じか、date_min <= dateStr <= date_max の範囲内
          if (event.next_date) {
            const next = new Date(event.next_date);
            next.setHours(0, 0, 0, 0);
            const target = new Date(dateStr);
            target.setHours(0, 0, 0, 0);
            return next.getTime() === target.getTime();
          }
          if (event.date_min && event.date_max) {
            return dateStr >= event.date_min && dateStr <= event.date_max;
          }
          return false;
        }).length;
        eventCounts[dateStr] = count;
      });

      // 今日の日付文字列
      const todayStr = today.toISOString().split('T')[0];

      // 曜日名
      const weekDayNames = ['日', '月', '火', '水', '木', '金', '土'];

      // リスト生成
      let html = '<div class="week-calendar-list">';

      weekDays.forEach(date => {
        const dateStr = date.toISOString().split('T')[0];
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const dayIndex = date.getDay(); // 0=日曜日, 1=月曜日, ..., 6=土曜日
        const dayName = weekDayNames[dayIndex];
        const count = eventCounts[dateStr] || 0;
        const isToday = dateStr === todayStr;
        const hasEvents = count > 0;

        let itemClass = 'week-day-item';
        if (isToday) itemClass += ' today';
        if (hasEvents) itemClass += ' has-events';

        html += `<div class="${itemClass}" onclick="goToDateEvents('${dateStr}')">`;
        html += `<span class="week-day-date">${month}/${day}</span>`;
        html += `<span class="week-day-name">${dayName}</span>`;
        if (hasEvents) {
          html += `<span class="week-day-count">${count}件</span>`;
        }
        html += `</div>`;
      });

      html += '</div>';
      
      // スライドアニメーション用のクラスを追加
      container.classList.add('week-calendar-sliding');
      setTimeout(() => {
        container.classList.remove('week-calendar-sliding');
      }, 300);
      
      container.innerHTML = html;

      // 次週ボタンの表示を更新
      const nextWeekBtn = document.getElementById('next-week-btn');
      if (nextWeekBtn) {
        if (offset === 0) {
          nextWeekBtn.textContent = '→';
          nextWeekBtn.onclick = () => showNextWeek();
        } else {
          nextWeekBtn.textContent = '←';
          nextWeekBtn.onclick = () => showThisWeek();
        }
      }
    }

    // 次週を表示
    function showNextWeek() {
      weekOffset = 1;
      renderWeekCalendar(weekOffset);
    }

    // 今週を表示
    function showThisWeek() {
      weekOffset = 0;
      renderWeekCalendar(weekOffset);
    }

    // 日付クリックでイベント一覧に遷移
    function goToDateEvents(dateStr) {
      window.location.href = `list.html?date=${dateStr}`;
    }

    // イベントブロックの表示（eventIndex ベース）
    function renderEventBlocks() {
      const MAX_HOME_EVENTS = 8;
      const index = Array.isArray(window.eventIndex) ? window.eventIndex : [];

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // おすすめ：isRecommended でフィルタ
      const recommended = index
        .filter(e => e.isRecommended)
        .slice(0, MAX_HOME_EVENTS);

      // 新着：isNew でフィルタ
      const newEvents = index
        .filter(e => e.isNew)
        .slice(0, MAX_HOME_EVENTS);

      // 直近開催：next_date >= today でフィルタ
      const upcoming = index
        .filter(e => {
          if (!e.next_date) return false;
          const next = new Date(e.next_date);
          next.setHours(0, 0, 0, 0);
          const limit = new Date(today);
          limit.setDate(today.getDate() + 7);
          return next >= today && next <= limit;
        })
        .slice(0, MAX_HOME_EVENTS);

      CardRenderer.renderCarousel(recommended, 'recommended-events');
      CardRenderer.renderCarousel(newEvents, 'new-events');
      CardRenderer.renderCarousel(upcoming, 'upcoming-events');
    }

    // カルーセルスクロール
    function scrollCarousel(carouselId, direction) {
      const carousel = document.getElementById(carouselId);
      if (!carousel) return;
      
      const scrollAmount = 400;
      const currentScroll = carousel.scrollLeft;
      const newScroll = direction === 'right' 
        ? currentScroll + scrollAmount 
        : currentScroll - scrollAmount;
      
      carousel.scrollTo({
        left: newScroll,
        behavior: 'smooth'
      });
    }

    // 初期化（イベントインデックス＋メタデータ読み込み → 描画）
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // 一覧用インデックス＋メタデータのみを読み込み（軽量）
        await Promise.all([loadEventIndex(), loadEventMeta()]);

        const yearElement = document.getElementById('current-year');
        if (yearElement) {
          yearElement.textContent = new Date().getFullYear();
        }

        renderCategories();
        renderWeekCalendar();
        renderEventBlocks();

        // ヘッダー検索欄の表示切り替え（ヒステリシス付きで点滅を防止）
        let isHeaderSearchVisible = false;
        const SHOW_THRESHOLD = 150; // この位置を超えたら表示
        const HIDE_THRESHOLD = 80;  // この位置より上に戻ったら非表示

        function handleScroll() {
          const header = document.getElementById('main-header');
          const headerSearch = document.getElementById('header-search');
          if (!header || !headerSearch) return;

          const y = window.scrollY || window.pageYOffset || 0;

          if (!isHeaderSearchVisible && y > SHOW_THRESHOLD) {
            isHeaderSearchVisible = true;
            header.classList.add('scrolled');
            headerSearch.style.display = 'block';
          } else if (isHeaderSearchVisible && y < HIDE_THRESHOLD) {
            isHeaderSearchVisible = false;
            header.classList.remove('scrolled');
            headerSearch.style.display = 'none';
          }
        }

        window.addEventListener('scroll', handleScroll);
        // 初期位置に応じて一度判定
        handleScroll();
      } catch (e) {
        console.error(e);
        const el = document.getElementById('error');
        if (el) el.textContent = 'データの読み込みに失敗しました';
      }
    });
  </script>
</body>
</html>
