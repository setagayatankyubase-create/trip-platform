<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="è‡ªç„¶ä½“é¨“ã‚’æä¾›ã™ã‚‹æä¾›å…ƒä¸€è¦§ã€‚ä¿¡é ¼ã§ãã‚‹ä¸»å‚¬è€…ã‚’è¦‹ã¤ã‘ã‚ˆã†ã€‚">
  <title>æä¾›å…ƒä¸€è¦§ | ãã¨ãªã³</title>
  <link rel="icon" type="image/png" id="favicon-link">
  <link rel="stylesheet" href="styles.css">
  <script>
    // ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã‚’Cloudinaryã‹ã‚‰å–å¾—
    (function() {
      function setFavicon() {
        const faviconLink = document.getElementById('favicon-link');
        if (faviconLink && typeof window.getFaviconUrl === 'function') {
          faviconLink.href = window.getFaviconUrl();
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setFavicon);
      } else {
        setFavicon();
      }
    })();
  </script>
  <script>
    // GitHub raw URLï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šè¨­å®šï¼‰
    window.GITHUB_RAW_BASE = "https://raw.githubusercontent.com/setagayatankyubase-create/trip-platform/main";
  </script>
  <script>
    // ãƒ­ã‚´ç”»åƒã‚’Cloudinaryã‹ã‚‰å–å¾—ï¼ˆdata.jsèª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œï¼‰
    (function() {
      function setLogoUrl() {
        const logoImage = document.querySelector('.logo-image');
        if (logoImage && typeof window.getLogoUrl === 'function') {
          logoImage.src = window.getLogoUrl();
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setLogoUrl);
      } else {
        setLogoUrl();
      }
    })();
  </script>
</head>
<body>
  <header class="main-header" id="main-header">
    <div class="nav">
      <div class="nav-left">
        <a href="index.html" class="logo">
          <img src="" alt="ãã¨ãªã³" class="logo-image">
        </a>
      </div>
      <div class="nav-links">
        <a href="list.html">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</a>
        <a href="organizer-list.html">æä¾›å…ƒ</a>
        <a href="column.html">ã‚³ãƒ©ãƒ </a>
      </div>
    </div>
  </header>

  <main class="container">
    <div style="margin: 20px 0;">
      <h1 style="margin: 0 0 8px 0; font-size: 1.5rem;">æä¾›å…ƒä¸€è¦§</h1>
      <p style="color: #6c7a72; margin: 0;">è‡ªç„¶ä½“é¨“ã‚’æä¾›ã™ã‚‹ä¿¡é ¼ã§ãã‚‹æä¾›å…ƒã‚’ã”ç´¹ä»‹ã—ã¾ã™</p>
    </div>

    <div id="organizer-list" style="display: grid; gap: 20px; margin-top: 24px;"></div>
  </main>

  <footer class="main-footer">
    <div class="footer-content">
      <div class="footer-column">
        <h3>ã‚µãƒãƒ¼ãƒˆ</h3>
        <a href="contact.html">ãŠå•ã„åˆã‚ã›</a>
        <a href="terms.html">åˆ©ç”¨è¦ç´„</a>
        <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
      </div>
      <div class="footer-column">
        <h3>é‹å–¶æƒ…å ±</h3>
        <a href="about.html">é‹å–¶ã«ã¤ã„ã¦</a>
      </div>
      <div class="footer-column">
        <h3>æ²è¼‰ã«ã¤ã„ã¦</h3>
        <a href="publish.html">æ²è¼‰ã«ã¤ã„ã¦</a>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-copyright">
        Â© <span id="current-year"></span> ãã¨ãªã³. è£½ä½œ
      </div>
    </div>
  </footer>

  <script src="data.js?v=3_2025-12-21"></script>
  <script>
    function renderOrganizers() {
      const container = document.getElementById('organizer-list');
      if (!container) return;

      if (eventData.organizers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¢</div>
          <h3>æä¾›å…ƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3>
          </div>
        `;
        return;
      }

      container.innerHTML = eventData.organizers.map(org => {
        const events = eventData.events.filter(e => (e.organizerId || e.organizer_id) === org.id);
        
        // æä¾›å…ƒãƒ­ã‚´URLã‚’å–å¾—ï¼ˆCloudinaryã‚’ä½¿ç”¨ã€ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã«å¯¾å¿œï¼‰
        let originalLogoUrl = org.logo || org.image || '';
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šlogoãŒç©ºã®å ´åˆã‚„ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®å ´åˆã€organizer.idã«åŸºã¥ã„ã¦Cloudinaryç”»åƒã‚’ç”Ÿæˆ
        const organizerId = org.id || '';
        let fallbackPaths = [];
        
        if (!originalLogoUrl || originalLogoUrl.includes('picsum.photos') || originalLogoUrl.includes('placeholder')) {
          // websiteãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç”»åƒåãŒå…¥ã£ã¦ã„ã‚‹å ´åˆï¼ˆä¾‹ï¼šorg-001_camppkï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
          const websiteValue = org.website || '';
          // URLã§ã¯ãªã„å ´åˆã®ã¿ç”»åƒåã¨ã—ã¦æ‰±ã†ï¼ˆhttp/httpsã‚’å«ã¾ãªã„ã€ãƒ‰ãƒƒãƒˆã‚’å«ã¾ãªã„ï¼‰
          if (websiteValue && !websiteValue.includes('http') && !websiteValue.includes('.com') && !websiteValue.includes('.')) {
            if (!websiteValue.includes('/')) {
              // å˜ç´”ãªç”»åƒåï¼ˆä¾‹ï¼šorg-001_camppkï¼‰ã®å ´åˆã€ãƒ•ã‚©ãƒ«ãƒ€ãƒ‘ã‚¹ã‚’è¿½åŠ 
              fallbackPaths = [
                `organizers/${organizerId}/${websiteValue}`,
                `organizers/${websiteValue}`,
                websiteValue
              ];
            } else {
              // æ—¢ã«ãƒ‘ã‚¹å½¢å¼ã®å ´åˆï¼ˆä¾‹ï¼šorganizers/org-001/org-001_camppkï¼‰
              fallbackPaths = [websiteValue];
            }
          }
          
          // websiteãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å–å¾—ã§ããªã„å ´åˆã€organizer.idã«åŸºã¥ã„ã¦ç”Ÿæˆ
          if (fallbackPaths.length === 0 && organizerId) {
            // è¤‡æ•°ã®ãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æº–å‚™
            fallbackPaths = [
              `organizers/${organizerId}/${organizerId}_camppk`,
              `organizers/${organizerId}_camppk`,
              `${organizerId}/${organizerId}_camppk`,
              `${organizerId}_camppk`
            ];
          }
          
          if (fallbackPaths.length > 0) {
            originalLogoUrl = fallbackPaths[0];
          }
        }
        
        let logoUrl = '';
        
        // Cloudinaryã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚´URLã‚’ç”Ÿæˆï¼ˆorganizersãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½¿ç”¨ï¼‰
        if (typeof window.getOrganizerImageUrl === 'function') {
          logoUrl = window.getOrganizerImageUrl(originalLogoUrl, { w: 400 });
        } else if (typeof window.cloudinaryUrl === 'function') {
          logoUrl = window.cloudinaryUrl(originalLogoUrl, { w: 400, type: 'organizer' });
        } else {
          logoUrl = originalLogoUrl;
        }
        
        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        const imageErrorHandler = fallbackPaths.length > 1 ? `
          (function() {
            const img = this;
            const currentSrc = img.src;
            const fallbackPaths = ${JSON.stringify(fallbackPaths)};
            const currentPathIndex = fallbackPaths.findIndex(p => currentSrc.includes(p));
            if (currentPathIndex >= 0 && currentPathIndex < fallbackPaths.length - 1) {
              const nextPath = fallbackPaths[currentPathIndex + 1];
              const nextUrl = typeof window.getOrganizerImageUrl === 'function' 
                ? window.getOrganizerImageUrl(nextPath, { w: 400 })
                : (typeof window.cloudinaryUrl === 'function' 
                  ? window.cloudinaryUrl(nextPath, { w: 400 })
                  : nextPath);
              img.src = nextUrl;
            } else {
              img.style.display = 'none';
            }
          }).call(this);
        ` : 'this.style.display=\'none\';';
        
        return `
          <div class="organizer-card">
            <div class="organizer-header">
              ${logoUrl ? `<img src="${logoUrl.replace(/"/g, '&quot;')}" alt="${org.name.replace(/"/g, '&quot;')}" class="organizer-logo" loading="lazy" decoding="async" onerror="${imageErrorHandler.replace(/"/g, '&quot;')}" />` : ''}
              <div class="organizer-info" style="flex: 1;">
                <h3 style="margin: 0 0 8px 0;">
                  <a href="organizer-detail.html?id=${org.id}" style="color: inherit; text-decoration: none;">
                    ${org.name}
                  </a>
                </h3>
                <p style="margin: 0; color: #6c7a72; line-height: 1.6;">${org.description}</p>
                <div class="organizer-meta">
                  ${(() => {
                    // è¨­ç«‹å¹´ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«å¯¾å¿œï¼šfounded_yearãŒmeta.jsonã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ï¼‰
                    const establishedYear = org.founded_year || org.establishedYear || org.foundedYear;
                    let displayYear = '';
                    if (establishedYear !== undefined && establishedYear !== null && establishedYear !== '') {
                      const yearStr = String(establishedYear).trim();
                      if (yearStr !== 'undefined' && yearStr !== 'null' && yearStr !== '') {
                        displayYear = `${yearStr}å¹´`;
                      }
                    }
                    
                    // è©•ä¾¡ã‚’å–å¾—ï¼ˆæœ‰åŠ¹ãªå ´åˆã®ã¿è¡¨ç¤ºï¼‰
                    const rating = parseFloat(org.rating) || 0;
                    const reviewCount = parseInt(org.reviewCount) || 0;
                    const displayRating = (rating > 0 && reviewCount > 0) ? `â˜…${rating} (${reviewCount}ä»¶)` : '';
                    
                    // ãƒ¡ã‚¿æƒ…å ±ã‚’çµ„ã¿ç«‹ã¦
                    const metaItems = [];
                    if (displayYear) {
                      metaItems.push(`<span>è¨­ç«‹: ${displayYear}</span>`);
                    }
                    if (displayRating) {
                      if (metaItems.length > 0) metaItems.push('<span> â€¢ </span>');
                      metaItems.push(`<span>è©•ä¾¡: ${displayRating}</span>`);
                    }
                    if (metaItems.length > 0) metaItems.push('<span> â€¢ </span>');
                    metaItems.push(`<span>é–‹å‚¬ã‚¤ãƒ™ãƒ³ãƒˆ: ${events.length}ä»¶</span>`);
                    
                    return metaItems.join('');
                  })()}
                </div>
              </div>
            </div>
            <div style="margin-top: 16px;">
              <a href="organizer-detail.html?id=${org.id}" class="btn" style="display: inline-block; text-align: center; padding: 12px 24px;">
                è©³ç´°ã‚’è¦‹ã‚‹ â†’
              </a>
            </div>
          </div>
        `;
      }).join('');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // APIã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒ»æä¾›å…ƒãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        await loadEventData();

        const yearElement = document.getElementById('current-year');
        if (yearElement) {
          yearElement.textContent = new Date().getFullYear();
        }
        renderOrganizers();
        
        // æ¤œç´¢å‡¦ç†ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼æ¤œç´¢æ¬„ç”¨ï¼‰
        window.handleSearch = function handleSearch(event) {
          event.preventDefault();
          const formData = new FormData(event.target);
          const params = {
            q: formData.get('q') || '',
            category: formData.get('category') || '',
            date: formData.get('date') || '',
            area: formData.get('area') || ''
          };
          const urlParams = new URLSearchParams();
          Object.keys(params).forEach(key => {
            if (params[key]) urlParams.set(key, params[key]);
          });
          window.location.href = `list.html?${urlParams.toString()}`;
        };
      } catch (e) {
        console.error(e);
        const el = document.getElementById('error');
        if (el) el.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    });
  </script>
</body>
</html>

