<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="è‡ªç„¶ä½“é¨“ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã€‚æ¤œç´¢æ¡ä»¶ã§çµã‚Šè¾¼ã‚“ã§ã€ã‚ãªãŸã«ã´ã£ãŸã‚Šã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’è¦‹ã¤ã‘ã‚ˆã†ã€‚">
  <title>ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ | ãã¨ãªã³</title>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/ddrxsy9jw/image/upload/f_auto,q_auto,w_32/logo_tfqqd0">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/ddrxsy9jw/image/upload/f_auto,q_auto,w_180/logo_tfqqd0">
  <link rel="stylesheet" href="styles.css">
  <script>
    // GitHub raw URLï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šè¨­å®šï¼‰
    window.GITHUB_RAW_BASE = "https://raw.githubusercontent.com/setagayatankyubase-create/trip-platform/main";
  </script>
  <script src="data.js"></script>
  <script>
    // ãƒ­ã‚´ç”»åƒã‚’Cloudinaryã‹ã‚‰å–å¾—ï¼ˆdata.jsèª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œï¼‰
    (function() {
      function setLogoUrl() {
        const logoImage = document.querySelector('.logo-image');
        if (logoImage && typeof window.getLogoUrl === 'function') {
          logoImage.src = window.getLogoUrl();
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setLogoUrl);
      } else {
        setLogoUrl();
      }
    })();
  </script>
</head>
<body>
  <header class="main-header" id="main-header">
    <div class="nav">
      <div class="nav-left">
        <a href="index.html" class="logo">
          <img src="" alt="ãã¨ãªã³" class="logo-image">
        </a>
      </div>
      <div class="nav-links">
        <a href="list.html">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</a>
        <a href="organizer-list.html">æä¾›å…ƒ</a>
        <a href="column.html">ã‚³ãƒ©ãƒ </a>
      </div>
    </div>
    <div class="search-bar">
      <div class="search-bar-wrapper" style="position: relative;">
        <form class="search-form" id="main-search-form" onsubmit="handleSearch(event)">
          <input type="text" id="search-query" placeholder="è¡ŒããŸã„è‡ªç„¶ä½“é¨“ãƒ»å ´æ‰€ã‚’æ¢ã™" name="q">
          <select id="search-category" name="category">
            <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
          </select>
          <input type="date" id="search-date" name="date">
          <select id="search-area" name="area">
            <option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>
          </select>
          <button type="submit">æ¤œç´¢</button>
        </form>
      </div>
    </div>
  </header>

  <main class="container">
    <div style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
      <h1 style="margin: 0; font-size: 1.5rem;">ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h1>
      <div style="display: flex; gap: 10px; align-items: center;">
        <button id="filter-trigger" class="filter-reset" style="display: none;" onclick="BottomSheet.open()">ãƒ•ã‚£ãƒ«ã‚¿</button>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼‰ -->
    <div class="filters" id="desktop-filters">
    </div>

    <!-- çµæœè¡¨ç¤ºï¼ˆ2ã‚«ãƒ©ãƒ ï¼šãƒªã‚¹ãƒˆ + ãƒãƒƒãƒ—ï¼‰ -->
    <div class="list-map-container">
      <!-- å·¦å´ï¼šã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒˆ -->
      <div class="event-list-column">
        <div style="margin-bottom: 16px; color: #6c7a72; font-size: 0.9rem;">
          <span id="result-count">0</span>ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ
          <span id="result-message"></span>
        </div>
        <div class="grid" id="event-list"></div>
        <div id="event-zero-suggestions"></div>
      </div>

      <!-- å³å´ï¼šãƒãƒƒãƒ— -->
      <div class="map-column">
        <div id="map-container" class="map-container">
          <div id="map"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
  <div id="bottom-sheet-overlay" class="bottom-sheet-overlay"></div>
  <div id="bottom-sheet" class="bottom-sheet">
    <div class="bottom-sheet-header">
      <h3 style="margin: 0;">ãƒ•ã‚£ãƒ«ã‚¿</h3>
      <button id="bottom-sheet-close" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text);">Ã—</button>
    </div>
    <div class="bottom-sheet-content">
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="mobile-filter-category" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px;">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
        </select>
      </div>
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">ã‚¨ãƒªã‚¢</label>
        <select id="mobile-filter-area" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px;">
          <option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>
        </select>
      </div>
      <div style="display: flex; gap: 10px;">
        <button onclick="applyMobileFilters()" style="flex: 1; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">é©ç”¨</button>
      </div>
    </div>
  </div>

  <footer class="main-footer">
    <div class="footer-content">
      <div class="footer-column">
        <h3>ã‚µãƒãƒ¼ãƒˆ</h3>
        <a href="contact.html">ãŠå•ã„åˆã‚ã›</a>
        <a href="terms.html">åˆ©ç”¨è¦ç´„</a>
        <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
      </div>
      <div class="footer-column">
        <h3>é‹å–¶æƒ…å ±</h3>
        <a href="about.html">é‹å–¶ã«ã¤ã„ã¦</a>
      </div>
      <div class="footer-column">
        <h3>æ²è¼‰ã«ã¤ã„ã¦</h3>
        <a href="publish.html">æ²è¼‰ã«ã¤ã„ã¦</a>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="footer-copyright">
        Â© <span id="current-year"></span> ãã¨ãªã³. è£½ä½œ
      </div>
    </div>
  </footer>

  <!-- Google Maps API -->
  <script>
    // Google Maps API ã‚­ãƒ¼ï¼ˆç’°å¢ƒã«å¿œã˜ã¦è¨­å®šï¼‰
    // ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯è¨­å®šã‹ã‚‰å–å¾—ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯è¨­å®šã—ã¦ãã ã•ã„
    window.GOOGLE_MAPS_API_KEY = window.GOOGLE_MAPS_API_KEY || '';
    
    // APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿Google Maps APIã‚’èª­ã¿è¾¼ã‚€
    if (window.GOOGLE_MAPS_API_KEY && window.GOOGLE_MAPS_API_KEY !== 'YOUR_API_KEY_HERE') {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_MAPS_API_KEY}&callback=initGoogleMaps&language=ja&region=JP`;
      script.async = true;
      script.defer = true;
      script.onerror = function() {
        console.error('[Google Maps] Failed to load Google Maps API');
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div class="map-placeholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f0f0f0; color: var(--text-secondary);">
              <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ—ºï¸</div>
                <div>Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
                <div style="font-size: 0.8rem; margin-top: 8px;">APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>
              </div>
            </div>
          `;
        }
      };
      document.head.appendChild(script);
    }
  </script>
  <script src="data.js?v=4_2025-12-25"></script>
  <script src="app.js"></script>
  <script>
    let currentEvents = [];
    let selectedEventId = null;

    // ãƒãƒƒãƒ—åˆæœŸåŒ–ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰
    function initMap() {
      if (!MapManager.mapInstance) {
        MapManager.init('map');
      }
      renderMapMarkers();
    }

    // ãƒãƒƒãƒ—ãƒãƒ¼ã‚«ãƒ¼ã®è¡¨ç¤º
    function renderMapMarkers() {
      MapManager.clearMarkers();
      currentEvents.forEach(event => {
        if (event.location && event.location.lat) {
          MapManager.addMarker(event, (eventId) => {
            // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒªã‚¹ãƒˆã®è©²å½“ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            selectEvent(eventId);
          });
        }
      });
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠï¼ˆãƒãƒ¼ã‚«ãƒ¼ or ãƒªã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ï¼‰
    window.selectEvent = function(eventId) {
      selectedEventId = eventId;
      
      // ãƒªã‚¹ãƒˆã®è©²å½“ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆ.card ã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ï¼‰
      document.querySelectorAll('.card').forEach(card => {
        const cardEventId = card.dataset.eventId;
        if (cardEventId === eventId) {
          card.classList.add('selected');
          // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤º
          card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          card.classList.remove('selected');
        }
      });
      
      // ãƒãƒƒãƒ—ã®ãƒãƒ¼ã‚«ãƒ¼ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      if (typeof MapManager !== 'undefined' && MapManager.focusMarker) {
        MapManager.focusMarker(eventId);
      }
    };

    // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    async function applyFilters() {
      const params = {
        q: document.getElementById('search-query')?.value || '',
        category: document.getElementById('search-category')?.value || '',
        area: document.getElementById('search-area')?.value || '',
        date: document.getElementById('search-date')?.value || '',
      };
      URLManager.updateParams(params);
      await loadEvents();
    }

    // ãƒ¢ãƒã‚¤ãƒ«ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    async function applyMobileFilters() {
      const params = {
        q: document.getElementById('search-query')?.value || '',
        category: document.getElementById('mobile-filter-category')?.value || '',
        area: document.getElementById('mobile-filter-area')?.value || '',
        date: document.getElementById('mobile-filter-date')?.value || '',
      };
      URLManager.updateParams(params);
      BottomSheet.close();
      await loadEvents();
    }

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªã‚»ãƒƒãƒˆ
    function resetFilters() {
      URLManager.setParams({});
      window.location.reload();
    }

    // æ¤œç´¢å‡¦ç†
    async function handleSearch(event) {
      event.preventDefault();
      const formData = new FormData(event.target);
      const params = {
        q: formData.get('q') || '',
        category: formData.get('category') || '',
        date: formData.get('date') || '',
        area: formData.get('area') || ''
      };
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ›´æ–°
      URLManager.setParams(params);
      // loadEvents ã¯ async ãªã®ã§ await ã™ã‚‹
      await loadEvents();
    }

    // ä¸€è¦§ç”¨ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ï¼ˆevents_index ã‚’å‰æã«è»½é‡å®Ÿè£…ï¼‰
    function filterIndexEvents(events, params, urlParams) {
      let filtered = [...events];

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆrecommended / new / upcomingï¼‰
      if (urlParams.get('recommended') === '1') {
        filtered = filtered.filter(e => e.isRecommended);
      } else if (urlParams.get('new') === '1') {
        filtered = filtered.filter(e => e.isNew);
      } else if (urlParams.get('upcoming') === '1') {
        filtered = filtered.filter(e => {
          if (!e.next_date) return false;
          const d = new Date(e.next_date);
          d.setHours(0, 0, 0, 0);
          return d >= today;
        });
      }

      // ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
      if (params.q) {
        const q = params.q.toLowerCase();
        filtered = filtered.filter(e => {
          const texts = [
            e.title,
            e.city,
            e.prefecture
          ];
          return texts.some(t => typeof t === 'string' && t.toLowerCase().includes(q));
        });
      }

      // ã‚«ãƒ†ã‚´ãƒªï¼ˆcategoryId ãŒç„¡ã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      if (params.category) {
        filtered = filtered.filter(e => {
          const catId = e.categoryId || e.category_id || '';
          return String(catId) === String(params.category);
        });
      }

      // ã‚¨ãƒªã‚¢ï¼ˆcity / prefecture ãƒ™ãƒ¼ã‚¹ã®ç°¡æ˜“å®Ÿè£…ï¼‰
      if (params.area) {
        filtered = filtered.filter(e => {
          const v = String(params.area);
          return e.city === v || e.prefecture === v || e.area === v;
        });
      }

      // æ—¥ä»˜ï¼ˆå˜æ—¥ï¼‰
      if (params.date) {
        const target = new Date(params.date);
        target.setHours(0, 0, 0, 0);
        filtered = filtered.filter(e => {
          // datesé…åˆ—ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯ï¼ˆè¤‡æ•°æ—¥ç¨‹ã«å¯¾å¿œï¼‰
          if (e.dates && Array.isArray(e.dates) && e.dates.length > 0) {
            const matched = e.dates.some(d => {
              if (!d.date) return false;
              const eventDate = new Date(d.date);
              eventDate.setHours(0, 0, 0, 0);
              return eventDate.getTime() === target.getTime();
            });
            if (matched) return true;
          }
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: next_date / date_min / date_max ã‚’ãƒã‚§ãƒƒã‚¯
          const next = e.next_date ? new Date(e.next_date) : null;
          if (next) {
            next.setHours(0, 0, 0, 0);
            if (next.getTime() === target.getTime()) return true;
          }
          const min = e.date_min ? new Date(e.date_min) : null;
          const max = e.date_max ? new Date(e.date_max) : null;
          if (min && max) {
            min.setHours(0, 0, 0, 0);
            max.setHours(0, 0, 0, 0);
            return target >= min && target <= max;
          }
          return false;
        });
      }

      // é–‹å‚¬é€±ï¼ˆä»Šé€± / æ¥é€±ï¼‰
      if (params.weekday === 'this-week' || params.weekday === 'next-week') {
        const dayOfWeek = today.getDay(); // 0=æ—¥
        const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - daysFromMonday + (params.weekday === 'next-week' ? 7 : 0));
        startOfWeek.setHours(0, 0, 0, 0);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);

        filtered = filtered.filter(e => {
          // datesé…åˆ—ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯ï¼ˆè¤‡æ•°æ—¥ç¨‹ã«å¯¾å¿œï¼‰
          if (e.dates && Array.isArray(e.dates) && e.dates.length > 0) {
            const matched = e.dates.some(d => {
              if (!d.date) return false;
              const eventDate = new Date(d.date);
              eventDate.setHours(0, 0, 0, 0);
              return eventDate >= startOfWeek && eventDate <= endOfWeek;
            });
            if (matched) return true;
          }
          
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: next_date ã‚’ãƒã‚§ãƒƒã‚¯
          const next = e.next_date ? new Date(e.next_date) : null;
          if (!next) return false;
          next.setHours(0, 0, 0, 0);
          return next >= startOfWeek && next <= endOfWeek;
        });
      }

      return filtered;
    }

    // æ¤œç´¢æ¡ä»¶ã«è¿‘ã„ãŠã™ã™ã‚ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ï¼ˆevents_index ãƒ™ãƒ¼ã‚¹ï¼‰
    function getSimilarIndexEvents(events, params, limit = 8) {
      if (!Array.isArray(events) || events.length === 0) return [];

      const q = (params.q || '').toLowerCase();
      const categoryId = params.category || '';
      const areaParam = params.area || '';
      const dateParam = params.date || '';
      const weekdayParam = params.weekday || '';

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let targetStart = null;
      let targetEnd = null;

      // æ—¥ä»˜æŒ‡å®š or ä»Šé€±/æ¥é€± ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæœŸé–“ã¨ã—ã¦ä½¿ã†
      if (dateParam) {
        const d = new Date(dateParam);
        d.setHours(0, 0, 0, 0);
        targetStart = new Date(d);
        targetEnd = new Date(d);
      } else if (weekdayParam === 'this-week' || weekdayParam === 'next-week') {
        const dayOfWeek = today.getDay(); // 0=æ—¥
        const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        targetStart = new Date(today);
        targetStart.setDate(today.getDate() - daysFromMonday + (weekdayParam === 'next-week' ? 7 : 0));
        targetStart.setHours(0, 0, 0, 0);
        targetEnd = new Date(targetStart);
        targetEnd.setDate(targetStart.getDate() + 6);
      }

      const scored = events
        .map(event => {
          let score = 0;

          // ã‚«ãƒ†ã‚´ãƒªä¸€è‡´
          if (categoryId) {
            if (String(event.categoryId || '') === String(categoryId)) {
              score += 5;
            }
          }

          // ã‚¨ãƒªã‚¢ä¸€è‡´ï¼ˆcity / prefecture / areaï¼‰
          if (areaParam) {
            if (event.city === areaParam) score += 4;
            if (event.prefecture === areaParam) score += 3;
            if (event.area === areaParam) score += 2;
          }

          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚¨ãƒªã‚¢ï¼‰
          if (q) {
            const text = `${event.title || ''} ${event.city || ''} ${event.prefecture || ''}`.toLowerCase();
            if (text.includes(q)) score += 4;
          }

          // æ—¥ç¨‹ã®è¿‘ã•ï¼ˆdatesé…åˆ— / next_date / date_min / date_maxï¼‰
          if (targetStart && targetEnd) {
            let bestScore = 0;
            
            // datesé…åˆ—ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯ï¼ˆè¤‡æ•°æ—¥ç¨‹ã«å¯¾å¿œï¼‰
            if (event.dates && Array.isArray(event.dates) && event.dates.length > 0) {
              event.dates.forEach(d => {
                if (!d.date) return;
                const eventDate = new Date(d.date);
                eventDate.setHours(0, 0, 0, 0);
                
                if (eventDate >= targetStart && eventDate <= targetEnd) {
                  bestScore = Math.max(bestScore, 5); // æœŸé–“å†…ãªã‚‰æœ€é«˜ã‚¹ã‚³ã‚¢
                } else {
                  const center = new Date((targetStart.getTime() + targetEnd.getTime()) / 2);
                  const diffDays = Math.abs(eventDate - center) / (1000 * 60 * 60 * 24);
                  if (diffDays <= 7) {
                    bestScore = Math.max(bestScore, Math.max(1, 4 - Math.floor(diffDays)));
                  }
                }
              });
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: next_date / date_min
            if (bestScore === 0) {
              let base = null;
              if (event.next_date) {
                base = new Date(event.next_date);
              } else if (event.date_min) {
                base = new Date(event.date_min);
              }

              if (base) {
                base.setHours(0, 0, 0, 0);
                if (base >= targetStart && base <= targetEnd) {
                  bestScore = 5;
                } else {
                  const center = new Date((targetStart.getTime() + targetEnd.getTime()) / 2);
                  const diffDays = Math.abs(base - center) / (1000 * 60 * 60 * 24);
                  if (diffDays <= 7) {
                    bestScore = Math.max(1, 4 - Math.floor(diffDays));
                  }
                }
              }
            }
            
            score += bestScore;
          }

          return { event, score };
        })
        .filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score);

      let result = scored.slice(0, limit).map(item => item.event);

      // ãã‚Œã§ã‚‚ç©ºãªã‚‰ã€å˜ç´”ã«ãŠã™ã™ã‚ãƒ•ãƒ©ã‚°ä»˜ã or ç›´è¿‘é–‹å‚¬ã‹ã‚‰åŸ‹ã‚ã‚‹
      if (result.length === 0) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const recommended = events.filter(e => e.isRecommended);
        if (recommended.length) {
          result = recommended.slice(0, limit);
        } else {
          result = events
            .map(e => {
              const d = e.next_date ? new Date(e.next_date) : today;
              d.setHours(0, 0, 0, 0);
              const diff = Math.abs(d - today) / (1000 * 60 * 60 * 24);
              return { event: e, diff };
            })
            .sort((a, b) => a.diff - b.diff)
            .slice(0, limit)
            .map(item => item.event);
        }
      }

      return result;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆèª­ã¿è¾¼ã¿ï¼ˆevents_index ãƒ™ãƒ¼ã‚¹ï¼‰
    async function loadEvents() {
      const params = URLManager.getParams();
      const urlParams = new URLSearchParams(window.location.search);

      // events_index ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯å¾…ã¤
      if (!Array.isArray(window.eventIndex)) {
        try {
          await loadEventIndex();
        } catch (e) {
          console.error('Failed to load event index:', e);
        }
      }

      // events_index ãŒå‰æ
      let index = Array.isArray(window.eventIndex) ? window.eventIndex : [];

      // ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ã§ categoryId ãŒç„¡ã„å ´åˆã€è©³ç´°JSONã‹ã‚‰è£œå®Œ
      if (params.category && index.length > 0 && !index[0].categoryId && !index[0].category_id) {
        try {
          // æœ€åˆã®æ•°ä»¶ã ã‘è©³ç´°ã‚’èª­ã¿è¾¼ã‚“ã§ categoryId ã‚’è£œå®Œ
          const sampleIds = index.slice(0, 10).map(e => e.id).filter(Boolean);
          const detailPromises = sampleIds.map(id => 
            loadEventDetail(id).catch(() => null)
          );
          const details = await Promise.all(detailPromises);
          const detailMap = {};
          details.forEach(d => {
            if (d && d.id) detailMap[d.id] = d;
          });
          
          // index ã« categoryId ã‚’è£œå®Œ
          index = index.map(item => {
            const detail = detailMap[item.id];
            if (detail && detail.categoryId) {
              return { ...item, categoryId: detail.categoryId };
            }
            return item;
          });
        } catch (e) {
          console.warn('Failed to enrich categoryId:', e);
        }
      }

      // æ—¥ä»˜æ¤œç´¢ã®å ´åˆã€è©³ç´°JSONã‹ã‚‰ dates é…åˆ—ã‚’è£œå®Œ
      if (params.date && index.length > 0) {
        try {
          const target = new Date(params.date);
          target.setHours(0, 0, 0, 0);
          
          console.log('[list.html] Date search - target date:', params.date, 'target object:', target);
          console.log('[list.html] Date search - index length:', index.length);
          console.log('[list.html] Date search - sample event:', index[0]);
          
          // date_min ã¨ date_max ã§å€™è£œã‚’çµã‚Šè¾¼ã¿ï¼ˆç¯„å›²å†…ã«ã‚ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼‰
          const candidateIds = index
            .filter(e => {
              // date_min/date_maxãŒã‚ã‚‹å ´åˆã¯ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
              if (e.date_min && e.date_max) {
                const min = new Date(e.date_min);
                const max = new Date(e.date_max);
                min.setHours(0, 0, 0, 0);
                max.setHours(0, 0, 0, 0);
                const inRange = target >= min && target <= max;
                if (inRange) {
                  console.log('[list.html] Candidate found:', e.id, 'date_min:', e.date_min, 'date_max:', e.date_max);
                }
                // ç¯„å›²å†…ãªã‚‰å€™è£œ
                return inRange;
              }
              // date_min/date_maxãŒãªã„å ´åˆã¯ã€next_dateãŒä¸€è‡´ã™ã‚‹å¯èƒ½æ€§ã‚’è€ƒæ…®
              if (e.next_date) {
                const next = new Date(e.next_date);
                next.setHours(0, 0, 0, 0);
                const matches = next.getTime() === target.getTime();
                if (matches) {
                  console.log('[list.html] Candidate found by next_date:', e.id, 'next_date:', e.next_date);
                }
                return matches;
              }
              // ã©ã¡ã‚‰ã‚‚ãªã„å ´åˆã¯å€™è£œã‹ã‚‰é™¤å¤–
              return false;
            })
            .map(e => e.id)
            .filter(Boolean);
          
          console.log('[list.html] Date search candidates:', candidateIds.length, candidateIds);
          
          // å€™è£œãŒ0ä»¶ã®å ´åˆã¯ã€ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å€™è£œã¨ã—ã¦æ‰±ã†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          const finalCandidateIds = candidateIds.length > 0 ? candidateIds : index.map(e => e.id).filter(Boolean);
          
          if (candidateIds.length === 0) {
            console.warn('[list.html] No candidates found by date_min/date_max, checking all events');
          }
          
          // å€™è£œã®è©³ç´°JSONã‚’èª­ã¿è¾¼ã‚“ã§ dates é…åˆ—ã‚’è£œå®Œ
          const detailPromises = finalCandidateIds.map(id => 
            loadEventDetail(id).catch(() => null)
          );
          const details = await Promise.all(detailPromises);
          const detailMap = {};
          details.forEach(d => {
            if (d && d.id && d.dates && Array.isArray(d.dates)) {
              detailMap[d.id] = d;
            }
          });
          
          console.log('[list.html] Enriched dates for:', Object.keys(detailMap).length, 'events');
          
          // index ã« dates é…åˆ—ã‚’è£œå®Œ
          index = index.map(item => {
            const detail = detailMap[item.id];
            if (detail && detail.dates) {
              return { ...item, dates: detail.dates };
            }
            return item;
          });
        } catch (e) {
          console.error('Failed to enrich dates:', e);
        }
      }

      // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
      currentEvents = filterIndexEvents(index, params, urlParams);

      // çµæœè¡¨ç¤º
      CardRenderer.renderList(currentEvents, 'event-list');

      // ä»¶æ•°ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const resultCountEl = document.getElementById('result-count');
      const resultMessageEl = document.getElementById('result-message');
      if (resultCountEl) {
        resultCountEl.textContent = currentEvents.length;
      }
      if (resultMessageEl) {
        if (currentEvents.length === 0) {
          resultMessageEl.textContent = 'ã€‚æ¡ä»¶ã‚’å°‘ã—ã‚†ã‚‹ã‚ã‚‹ã‹ã€åˆ¥ã®åˆ‡ã‚Šå£ã‹ã‚‰æ¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
        } else {
          resultMessageEl.textContent = '';
        }
      }

      // 0ä»¶æ™‚ã®ãŠã™ã™ã‚å°ç·šï¼ˆæ¤œç´¢æ¡ä»¶ã«è¿‘ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¡¨ç¤ºï¼‰
      const zeroSuggestContainer = document.getElementById('event-zero-suggestions');
      if (zeroSuggestContainer) {
        zeroSuggestContainer.innerHTML = '';

        if (currentEvents.length === 0) {
          let similar = getSimilarIndexEvents(index, params, 8);

          // index ãƒ™ãƒ¼ã‚¹ã§å‡ºã›ãªã‹ã£ãŸå ´åˆã¯ã€å¾“æ¥ã©ãŠã‚Š full ãƒ‡ãƒ¼ã‚¿ï¼‹SearchFilter ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if ((!similar || similar.length === 0) && typeof SearchFilter !== 'undefined' && typeof loadEventData === 'function') {
            try {
              await loadEventData(); // é‡ã„ãŒã€0ä»¶æ™‚ã®ã¿ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              if (typeof SearchFilter.getSimilarEvents === 'function' && window.eventData && Array.isArray(window.eventData.events)) {
                similar = SearchFilter.getSimilarEvents(params, 8);
              }
            } catch (e) {
              console.warn('fallback getSimilarEvents failed:', e);
            }
          }

          if (similar.length) {
            const html = `
              <section class="empty-suggestions-section">
                <h4>æ¤œç´¢æ¡ä»¶ã«è¿‘ã„ãŠã™ã™ã‚ã‚¤ãƒ™ãƒ³ãƒˆ</h4>
                <div class="card-carousel-wrapper">
                  <div class="card-carousel">
                    ${similar.map(ev => CardRenderer.render(ev)).join('')}
                  </div>
                </div>
              </section>
            `;
            zeroSuggestContainer.innerHTML = html;
          }
        }
      }

      // ãƒãƒƒãƒ—æ›´æ–°
      renderMapMarkers();

      // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      const searchQueryEl = document.getElementById('search-query');
      const searchCategoryEl = document.getElementById('search-category');
      const searchDateEl = document.getElementById('search-date');
      const searchAreaEl = document.getElementById('search-area');
      const mobileFilterCategoryEl = document.getElementById('mobile-filter-category');
      const mobileFilterAreaEl = document.getElementById('mobile-filter-area');
      const mobileFilterDateEl = document.getElementById('mobile-filter-date');
      
      if (searchQueryEl) searchQueryEl.value = params.q || '';
      if (searchCategoryEl) searchCategoryEl.value = params.category || '';
      if (searchDateEl) searchDateEl.value = params.date || '';
      if (searchAreaEl) searchAreaEl.value = params.area || '';
      if (mobileFilterCategoryEl) mobileFilterCategoryEl.value = params.category || '';
      if (mobileFilterAreaEl) mobileFilterAreaEl.value = params.area || '';
      if (mobileFilterDateEl) mobileFilterDateEl.value = params.date || '';
    }

    // ã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¨ãƒªã‚¢ã®é¸æŠè‚¢ã‚’è¨­å®šï¼ˆeventMeta / eventIndex ãƒ™ãƒ¼ã‚¹ï¼‰
    function populateOptions() {
      const selects = [
        'search-category', 'mobile-filter-category'
      ];
      const areaSelects = [
        'search-area', 'mobile-filter-area'
      ];

      const categories = (window.eventMeta && window.eventMeta.categories)
        ? window.eventMeta.categories
        : (window.eventData && window.eventData.categories) ? window.eventData.categories : [];
      let areas = [];

      // ã‚«ãƒ†ã‚´ãƒª: å˜ç´”ã« id / name ã§è¡¨ç¤º
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select && categories.length) {
          categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
          });
        }
      });

      // ã‚¤ãƒ™ãƒ³ãƒˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰ã‚¨ãƒªã‚¢å€™è£œã‚’ç”Ÿæˆ
      const areaMap = {};
      if (Array.isArray(window.eventIndex)) {
        window.eventIndex.forEach(ev => {
          const id = ev.area || ev.city || ev.prefecture;
          const name = ev.area || ev.city || ev.prefecture;
          if (id && !areaMap[id]) {
            areaMap[id] = { id, name };
          }
        });
      }
      areas = Object.values(areaMap);

      // ã‚¨ãƒªã‚¢: æ–‡å­—åˆ—é…åˆ— or ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã®ä¸¡æ–¹ã«å¯¾å¿œ
      if (areas && areas.length) {
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé…åˆ—ã®å ´åˆã¯è¦ªå­é–¢ä¿‚ã‚’è€ƒæ…®ã—ã¦ãƒ©ãƒ™ãƒ«ã‚’ä½œã‚‹
        const first = areas[0];
        let areaById = {};
        let isObjectArea = typeof first === 'object';

        if (isObjectArea) {
          areas.forEach(a => {
            if (a && a.id) {
              areaById[a.id] = a;
            }
          });
        }

        areaSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            areas.forEach(area => {
              const option = document.createElement('option');

              if (typeof area === 'string') {
                // æ—§: æ–‡å­—åˆ—ã®ã‚¨ãƒªã‚¢åã ã‘ã‚’æŒã¤å ´åˆ
                option.value = area;
                option.textContent = area;
              } else if (area && typeof area === 'object') {
                // æ–°: id / name / parent_id ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                const value = area.id || area.slug || area.name;
                let label = area.name || area.slug || area.id;

                if (area.parent_id && areaById[area.parent_id]) {
                  const parent = areaById[area.parent_id];
                  const parentName = parent.name || parent.slug || parent.id;
                  label = `${parentName} - ${label}`;
                }

                option.value = value;
                option.textContent = label;
              }

              select.appendChild(option);
            });
          }
        });
      }
    }

    // ãƒ¢ãƒã‚¤ãƒ«åˆ¤å®š
    function checkMobile() {
      const isMobile = window.innerWidth <= 768;
      document.getElementById('desktop-filters').style.display = isMobile ? 'none' : 'flex';
      document.getElementById('filter-trigger').style.display = isMobile ? 'block' : 'none';
    }

    // åˆæœŸåŒ–
    // ã‚«ãƒ†ã‚´ãƒªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–ï¼ˆãƒ›ãƒãƒ¼ã§è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€äº‹å‰ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ãŠãï¼‰
    function initCategoryMenu() {
      const menuList = document.getElementById('category-menu-list');
      if (!menuList) return;

      if (!window.eventData || !window.eventData.categories) return;
      menuList.innerHTML = window.eventData.categories.map(cat => `
        <a href="list.html?category=${cat.id}" class="category-menu-item">
          <span class="icon">${cat.icon}</span>
          <span>${cat.name}</span>
        </a>
      `).join('');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // ä¸€è¦§ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’èª­ã¿è¾¼ã¿
        await Promise.all([loadEventIndex(), loadEventMeta()]);

        const yearElement = document.getElementById('current-year');
        if (yearElement) {
          yearElement.textContent = new Date().getFullYear();
        }
        populateOptions();
        initCategoryMenu(); // ã‚«ãƒ†ã‚´ãƒªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’åˆæœŸåŒ–
        checkMobile();
        initMap(); // ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–
        loadEvents();
        window.addEventListener('resize', checkMobile);

      } catch (e) {
        console.error(e);
        const el = document.getElementById('error');
        if (el) el.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
      }
    });
  </script>
</body>
</html>

